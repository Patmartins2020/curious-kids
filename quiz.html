<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Curious Kids – Quiz Arena</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#16a34a" />

    <!-- PWA / Icons (reuse your existing files) -->
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" type="image/png" href="icons/favicon.png" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />

    <style>
      :root {
        --primary: #ff8a3d;
        --primary-dark: #e46f22;
        --secondary: #4d8fff;
        --card-bg: #ffffff;
        --bg: #f7fbff;
        --text: #0f172a;
        --muted: #6b7280;
        --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
        --radius-lg: 18px;
        --radius-sm: 10px;
        --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--font-main);
        background: radial-gradient(
          circle at top,
          #e0f2ff 0,
          #f7fbff 45%,
          #ffffff 100%
        );
        color: var(--text);
        min-height: 100vh;
      }

      a {
        text-decoration: none;
        color: inherit;
      }

      /* HEADER + NAVBAR */

      header {
        position: sticky;
        top: 0;
        z-index: 50;
        background: #16a34a;
        color: #f9fafb;
        border-bottom: 1px solid rgba(15, 23, 42, 0.15);
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.18);
      }

      .nav-inner {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0.6rem 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 0.6rem;
      }

      .brand-logo {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: conic-gradient(
          from 180deg,
          #ff8a3d,
          #ffd74d,
          #4d8fff,
          #16a34a,
          #ff8a3d
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: 800;
        font-size: 1.1rem;
        box-shadow: 0 4px 14px rgba(15, 23, 42, 0.35);
      }

      .brand-text {
        display: flex;
        flex-direction: column;
        line-height: 1.1;
      }

      .brand-text span:first-child {
        font-weight: 800;
        font-size: 1rem;
        letter-spacing: 0.03em;
      }

      .brand-text span:last-child {
        font-size: 0.75rem;
        color: rgba(226, 232, 240, 0.9);
      }

      nav ul {
        list-style: none;
        display: flex;
        gap: 0.75rem;
        font-size: 0.9rem;
        align-items: center;
      }

      nav a {
        padding: 0.35rem 0.8rem;
        border-radius: 999px;
        color: #e5e7eb;
        font-weight: 500;
        transition: background 0.15s, color 0.15s, transform 0.1s;
      }

      nav a:hover {
        background: rgba(255, 255, 255, 0.16);
        color: #ffffff;
        transform: translateY(-1px);
      }

      .nav-cta {
        background: #ffffff;
        color: #0f172a;
        box-shadow: 0 3px 10px rgba(15, 23, 42, 0.35);
      }

      /* MAIN LAYOUT */

      main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 1.6rem 1rem 2.6rem;
      }

      .hero {
        margin-bottom: 1.6rem;
        text-align: center;
      }

      .hero-kicker {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #059669;
        font-weight: 700;
        margin-bottom: 0.3rem;
      }

      .hero-title {
        font-size: clamp(1.4rem, 2.6vw, 1.9rem);
        font-weight: 800;
        margin-bottom: 0.4rem;
        color: #0f172a;
      }

      .hero-sub {
        font-size: 0.9rem;
        color: var(--muted);
        max-width: 600px;
        margin: 0 auto;
      }

      .quiz-layout {
        display: grid;
        grid-template-columns: minmax(0, 2.3fr) minmax(0, 1.7fr);
        gap: 1.3rem;
        align-items: flex-start;
      }

      @media (max-width: 860px) {
        .quiz-layout {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 1.1rem 1rem;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(148, 163, 184, 0.25);
      }

      .card-title {
        font-size: 0.95rem;
        font-weight: 700;
        margin-bottom: 0.4rem;
      }

      .card-sub {
        font-size: 0.8rem;
        color: var(--muted);
        margin-bottom: 0.7rem;
      }

      .field-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.2rem;
      }

      select,
      input[type="text"],
      input[type="number"],
      textarea {
        font-size: 0.82rem;
        padding: 0.4rem 0.5rem;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.9);
        outline: none;
        width: 100%;
        margin-bottom: 0.5rem;
        resize: vertical;
      }

      select:focus,
      input[type="text"]:focus,
      input[type="number"]:focus,
      textarea:focus {
        border-color: #16a34a;
        box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.2);
      }

      .mode-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        margin-bottom: 0.7rem;
      }

      .mode-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.7rem;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.8);
        font-size: 0.78rem;
        cursor: pointer;
        background: #f9fafb;
      }

      .mode-pill.selected {
        border-color: #16a34a;
        background: #ecfdf5;
        color: #065f46;
      }

      .mode-pill input {
        margin: 0;
      }

      .players-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }

      @media (max-width: 520px) {
        .players-grid {
          grid-template-columns: 1fr;
        }
      }

      .helper-text {
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
      }

      .btn-primary {
        border-radius: 999px;
        border: none;
        padding: 0.55rem 1.1rem;
        font-size: 0.85rem;
        font-weight: 700;
        background: var(--primary);
        color: #ffffff;
        cursor: pointer;
        box-shadow: 0 5px 16px rgba(248, 113, 22, 0.55);
        transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .btn-ghost {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.8);
        padding: 0.45rem 0.9rem;
        font-size: 0.78rem;
        font-weight: 600;
        background: #f9fafb;
        cursor: pointer;
      }

      .btn-ghost:hover {
        background: #e5e7eb;
      }

      .btn-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 0.4rem;
      }

      .quiz-status {
        margin-top: 0.8rem;
        font-size: 0.78rem;
        color: #4b5563;
      }

      /* QUIZ PLAY AREA */

      .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.4rem;
        font-size: 0.8rem;
      }

      .question-pill {
        padding: 0.2rem 0.65rem;
        border-radius: 999px;
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1d4ed8;
        font-weight: 600;
        font-size: 0.78rem;
      }

      .player-pill {
        padding: 0.2rem 0.65rem;
        border-radius: 999px;
        background: #ecfdf5;
        border: 1px solid #6ee7b7;
        color: #065f46;
        font-weight: 600;
        font-size: 0.78rem;
      }

      .question-text {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.6rem;
      }

      .options-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.5rem;
        margin-bottom: 0.4rem;
      }

      .option-btn {
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.8);
        padding: 0.55rem 0.7rem;
        font-size: 0.9rem;
        background: #f9fafb;
        cursor: pointer;
        text-align: left;
        transition: background 0.15s, border 0.15s, transform 0.1s;
      }

      .option-btn:hover {
        background: #e5f3ff;
        transform: translateY(-1px);
      }

      .option-btn.correct {
        background: #dcfce7;
        border-color: #16a34a;
      }

      .option-btn.incorrect {
        background: #fee2e2;
        border-color: #f87171;
      }

      .feedback-text {
        font-size: 0.8rem;
        margin-top: 0.3rem;
      }

      .feedback-text.correct {
        color: #16a34a;
      }

      .feedback-text.incorrect {
        color: #b91c1c;
      }

      .scoreboard {
        margin-top: 0.8rem;
        border-top: 1px dashed rgba(148, 163, 184, 0.7);
        padding-top: 0.6rem;
      }

      .scoreboard-title {
        font-size: 0.82rem;
        font-weight: 700;
        margin-bottom: 0.3rem;
      }

      .score-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        margin-bottom: 0.2rem;
      }

      .score-row span:first-child {
        font-weight: 600;
      }

      .results-panel {
        margin-top: 0.8rem;
        border-radius: 12px;
        padding: 0.7rem 0.75rem;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        font-size: 0.82rem;
      }

      .results-list {
        margin-top: 0.35rem;
        padding-left: 1rem;
        font-size: 0.8rem;
      }

      .results-list li {
        margin-bottom: 0.2rem;
      }

      /* CUSTOM QUIZ BUILDER */

      .cq-helper {
        font-size: 0.78rem;
        color: #6b7280;
        margin-bottom: 0.6rem;
      }

      .cq-question-block {
        border-radius: 12px;
        border: 1px dashed rgba(148, 163, 184, 0.7);
        background: #f9fafb;
        padding: 0.6rem 0.7rem;
        margin-bottom: 0.7rem;
      }

      .cq-question-title {
        font-size: 0.82rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.4rem;
      }

      .cq-options-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.4rem;
      }

      @media (max-width: 640px) {
        .cq-options-row {
          grid-template-columns: 1fr;
        }
      }

      .cq-small-label {
        font-size: 0.75rem;
        color: #4b5563;
        margin-bottom: 0.2rem;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="nav-inner">
        <div class="brand">
          <div class="brand-logo">CK</div>
          <div class="brand-text">
            <span>Curious Kids</span>
            <span>Quiz Arena</span>
          </div>
        </div>
        <nav>
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="ask.html">Ask a Question</a></li>
            <li><a href="store.html">Store</a></li>
            <li><a href="parents.html">For Parents</a></li>
            <li><a href="plans.html">Uncle Pat Plans</a></li>
            <li><a class="nav-cta" href="quiz.html">Quiz Arena</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main>
      <section class="hero">
        <div class="hero-kicker">Play & Learn</div>
        <h1 class="hero-title">Curious Kids Quiz Arena</h1>
        <p class="hero-sub">
          Bible stories, feelings, and everyday choices turned into gentle, fun
          quizzes for kids and families. Play alone, take turns, or create your
          own quiz on this device.
        </p>
      </section>

      <section class="quiz-layout">
        <!-- LEFT: Setup -->
        <div class="card">
          <h2 class="card-title">1. Choose quiz & mode</h2>
          <p class="card-sub">
            Pick a ready-made quiz or one of your saved quizzes, then decide if
            you want to play alone or with friends on the same device.
          </p>

          <div>
            <p class="field-label">Quiz set</p>
            <select id="quizSelect">
              <!-- Populated by JS -->
            </select>
            <p class="helper-text" id="myQuizzesHint">
              Built-in quizzes appear first. Your saved quizzes (from the
              builder below) will appear under “My Quizzes”.
            </p>
          </div>

          <div style="margin-top:0.4rem;">
            <p class="field-label">Mode</p>
            <div class="mode-row">
              <label class="mode-pill selected" data-mode="solo" id="modeSoloPill">
                <input
                  type="radio"
                  name="mode"
                  value="solo"
                  checked
                />
                Solo (1 player)
              </label>
              <label class="mode-pill" data-mode="multi" id="modeMultiPill">
                <input
                  type="radio"
                  name="mode"
                  value="multi"
                />
                Pass-and-play (2–4 players)
              </label>
            </div>
          </div>

          <div id="playersConfig" style="margin-top:0.4rem; display:none;">
            <p class="field-label">Players</p>
            <p class="helper-text">
              Add 2–4 player names. Each player takes turns answering.
            </p>
            <div class="players-grid">
              <input
                type="text"
                id="playerName1"
                placeholder="Player 1"
              />
              <input
                type="text"
                id="playerName2"
                placeholder="Player 2"
              />
              <input
                type="text"
                id="playerName3"
                placeholder="Player 3 (optional)"
              />
              <input
                type="text"
                id="playerName4"
                placeholder="Player 4 (optional)"
              />
            </div>
          </div>

          <div class="btn-row">
            <button class="btn-primary" id="startQuizBtn">
              Start quiz
            </button>
            <button class="btn-ghost" id="resetQuizBtn" type="button">
              Reset
            </button>
          </div>

          <div class="quiz-status" id="quizStatus">
            No quiz running yet. Choose a set and press “Start quiz”.
          </div>
        </div>

        <!-- RIGHT: Quiz play + scoreboard -->
        <div class="card">
          <h2 class="card-title">2. Play</h2>
          <p class="card-sub">
            Questions will appear here. Tap an answer to see if you got it
            right. Take turns when playing with more than one player.
          </p>

          <div id="quizPlayArea">
            <div id="questionHeader" class="question-header" style="display:none;">
              <span class="question-pill" id="questionProgress"></span>
              <span class="player-pill" id="currentPlayerLabel"></span>
            </div>

            <div id="questionText" class="question-text">
              No question yet. Start a quiz to begin.
            </div>

            <div id="optionsContainer" class="options-grid"></div>

            <div id="feedback" class="feedback-text"></div>

            <div class="scoreboard" id="scoreboard" style="display:none;">
              <div class="scoreboard-title">Scoreboard</div>
              <div id="scoreRows"></div>
            </div>

            <div id="resultsPanel" class="results-panel" style="display:none;">
              <div><strong>Game over!</strong> Here are the final results:</div>
              <ul class="results-list" id="resultsList"></ul>
              <div style="margin-top:.4rem;">
                <button class="btn-ghost" id="playAgainBtn" type="button">
                  Play again with same settings
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- CUSTOM QUIZ BUILDER -->
      <section class="card" style="margin-top:1.5rem;">
        <h2 class="card-title">3. Create your own quiz (on this device)</h2>
        <p class="cq-helper">
          Build a small quiz for your child, class, or friends. Saved quizzes
          stay on this device only and will appear in the quiz list above under
          “My Quizzes”.
        </p>

        <div>
          <p class="field-label">Quiz title</p>
          <input
            type="text"
            id="customQuizTitle"
            placeholder="e.g. Sarah’s Bible Quiz or Feelings Check-In"
          />
        </div>

        <!-- Question 1 -->
        <div class="cq-question-block">
          <div class="cq-question-title">Question 1</div>
          <p class="cq-small-label">Question text</p>
          <textarea
            id="cqQ1Text"
            rows="2"
            placeholder="e.g. Who was thrown into the lions’ den?"
          ></textarea>

          <p class="cq-small-label">Answer options</p>
          <div class="cq-options-row">
            <input type="text" id="cqQ1Opt1" placeholder="Option 1" />
            <input type="text" id="cqQ1Opt2" placeholder="Option 2" />
            <input type="text" id="cqQ1Opt3" placeholder="Option 3 (optional)" />
            <input type="text" id="cqQ1Opt4" placeholder="Option 4 (optional)" />
          </div>

          <p class="cq-small-label">Correct answer</p>
          <select id="cqQ1Correct">
            <option value="">Choose…</option>
            <option value="0">Option 1</option>
            <option value="1">Option 2</option>
            <option value="2">Option 3</option>
            <option value="3">Option 4</option>
          </select>
        </div>

        <!-- Question 2 -->
        <div class="cq-question-block">
          <div class="cq-question-title">Question 2 (optional)</div>
          <p class="cq-small-label">Question text</p>
          <textarea
            id="cqQ2Text"
            rows="2"
            placeholder="Leave empty if you only want one question."
          ></textarea>

          <p class="cq-small-label">Answer options</p>
          <div class="cq-options-row">
            <input type="text" id="cqQ2Opt1" placeholder="Option 1" />
            <input type="text" id="cqQ2Opt2" placeholder="Option 2" />
            <input type="text" id="cqQ2Opt3" placeholder="Option 3 (optional)" />
            <input type="text" id="cqQ2Opt4" placeholder="Option 4 (optional)" />
          </div>

          <p class="cq-small-label">Correct answer</p>
          <select id="cqQ2Correct">
            <option value="">Choose…</option>
            <option value="0">Option 1</option>
            <option value="1">Option 2</option>
            <option value="2">Option 3</option>
            <option value="3">Option 4</option>
          </select>
        </div>

        <!-- Question 3 -->
        <div class="cq-question-block">
          <div class="cq-question-title">Question 3 (optional)</div>
          <p class="cq-small-label">Question text</p>
          <textarea
            id="cqQ3Text"
            rows="2"
            placeholder="You can add up to 3 questions in this version."
          ></textarea>

          <p class="cq-small-label">Answer options</p>
          <div class="cq-options-row">
            <input type="text" id="cqQ3Opt1" placeholder="Option 1" />
            <input type="text" id="cqQ3Opt2" placeholder="Option 2" />
            <input type="text" id="cqQ3Opt3" placeholder="Option 3 (optional)" />
            <input type="text" id="cqQ3Opt4" placeholder="Option 4 (optional)" />
          </div>

          <p class="cq-small-label">Correct answer</p>
          <select id="cqQ3Correct">
            <option value="">Choose…</option>
            <option value="0">Option 1</option>
            <option value="1">Option 2</option>
            <option value="2">Option 3</option>
            <option value="3">Option 4</option>
          </select>
        </div>

        <div class="btn-row">
          <button class="btn-primary" id="saveCustomQuizBtn" type="button">
            Save this quiz on this device
          </button>
          <button class="btn-ghost" id="clearCustomQuizBtn" type="button">
            Clear fields
          </button>
        </div>

        <p class="cq-helper" id="customQuizStatus" style="margin-top:0.5rem;">
          No custom quiz saved yet.
        </p>
      </section>
    </main>

    <script>
      // -------------------
      // Quiz data (built-in sets)
      // -------------------
      const QUIZ_SETS = [
        {
          id: 'bible-basics-1',
          title: 'Bible Basics – Set 1',
          category: 'Bible',
          difficulty: 'easy',
          questions: [
            {
              id: 'q1',
              text: 'Who built the ark?',
              options: ['Moses', 'Noah', 'David', 'Paul'],
              correctIndex: 1
            },
            {
              id: 'q2',
              text: 'What did Jesus do at the wedding in Cana?',
              options: [
                'Walked on water',
                'Fed 5,000 people',
                'Turned water into wine',
                'Calmed the storm'
              ],
              correctIndex: 2
            },
            {
              id: 'q3',
              text: 'Where was Jesus born?',
              options: ['Bethlehem', 'Jerusalem', 'Nazareth', 'Egypt'],
              correctIndex: 0
            },
            {
              id: 'q4',
              text: 'What did David use to defeat Goliath?',
              options: [
                'A sword',
                'A slingshot and stone',
                'A spear',
                'His bare hands'
              ],
              correctIndex: 1
            }
          ]
        },
        {
          id: 'feelings-kindness-1',
          title: 'Feelings & Kindness',
          category: 'Feelings',
          difficulty: 'easy',
          questions: [
            {
              id: 'f1',
              text: 'If your friend is sad, what is a kind thing to do?',
              options: [
                'Laugh at them',
                'Ignore them',
                'Ask what is wrong and listen',
                'Tell them to go away'
              ],
              correctIndex: 2
            },
            {
              id: 'f2',
              text: 'When you feel angry, what is a helpful first step?',
              options: [
                'Shout at someone',
                'Hit something',
                'Take a deep breath and pause',
                'Hide your feelings forever'
              ],
              correctIndex: 2
            },
            {
              id: 'f3',
              text: 'If you break something that is not yours, what should you do?',
              options: [
                'Blame someone else',
                'Run away',
                'Tell the truth and say sorry',
                'Pretend nothing happened'
              ],
              correctIndex: 2
            },
            {
              id: 'f4',
              text: 'What does it mean to forgive?',
              options: [
                'Never talk to the person again',
                'Let go of anger and choose not to pay them back',
                'Tell everyone what they did',
                'Keep remembering it forever'
              ],
              correctIndex: 1
            }
          ]
        }
      ];

      const CUSTOM_QUIZ_KEY = 'curiousKidsCustomQuizzes';
      let customQuizzes = [];

      // -------------------
      // State
      // -------------------
      let currentQuiz = null;
      let currentQuestionIndex = 0;
      let mode = 'solo'; // 'solo' or 'multi'
      let players = []; // { name, score }
      let currentPlayerIndex = 0;
      let quizRunning = false;

      // -------------------
      // Elements
      // -------------------
      const quizSelect = document.getElementById('quizSelect');
      const modeSoloPill = document.getElementById('modeSoloPill');
      const modeMultiPill = document.getElementById('modeMultiPill');
      const playersConfig = document.getElementById('playersConfig');
      const startQuizBtn = document.getElementById('startQuizBtn');
      const resetQuizBtn = document.getElementById('resetQuizBtn');
      const quizStatus = document.getElementById('quizStatus');

      const questionHeader = document.getElementById('questionHeader');
      const questionProgress = document.getElementById('questionProgress');
      const currentPlayerLabel = document.getElementById('currentPlayerLabel');
      const questionText = document.getElementById('questionText');
      const optionsContainer = document.getElementById('optionsContainer');
      const feedback = document.getElementById('feedback');

      const scoreboard = document.getElementById('scoreboard');
      const scoreRows = document.getElementById('scoreRows');

      const resultsPanel = document.getElementById('resultsPanel');
      const resultsList = document.getElementById('resultsList');
      const playAgainBtn = document.getElementById('playAgainBtn');

      // Custom quiz builder elements
      const customQuizTitle = document.getElementById('customQuizTitle');
      const customQuizStatus = document.getElementById('customQuizStatus');
      const saveCustomQuizBtn = document.getElementById('saveCustomQuizBtn');
      const clearCustomQuizBtn = document.getElementById('clearCustomQuizBtn');

      // Question blocks
      const cqQ1Text = document.getElementById('cqQ1Text');
      const cqQ1Opt1 = document.getElementById('cqQ1Opt1');
      const cqQ1Opt2 = document.getElementById('cqQ1Opt2');
      const cqQ1Opt3 = document.getElementById('cqQ1Opt3');
      const cqQ1Opt4 = document.getElementById('cqQ1Opt4');
      const cqQ1Correct = document.getElementById('cqQ1Correct');

      const cqQ2Text = document.getElementById('cqQ2Text');
      const cqQ2Opt1 = document.getElementById('cqQ2Opt1');
      const cqQ2Opt2 = document.getElementById('cqQ2Opt2');
      const cqQ2Opt3 = document.getElementById('cqQ2Opt3');
      const cqQ2Opt4 = document.getElementById('cqQ2Opt4');
      const cqQ2Correct = document.getElementById('cqQ2Correct');

      const cqQ3Text = document.getElementById('cqQ3Text');
      const cqQ3Opt1 = document.getElementById('cqQ3Opt1');
      const cqQ3Opt2 = document.getElementById('cqQ3Opt2');
      const cqQ3Opt3 = document.getElementById('cqQ3Opt3');
      const cqQ3Opt4 = document.getElementById('cqQ3Opt4');
      const cqQ3Correct = document.getElementById('cqQ3Correct');

      // -------------------
      // Custom quiz storage
      // -------------------
      function loadCustomQuizzes() {
        try {
          const raw = localStorage.getItem(CUSTOM_QUIZ_KEY);
          const parsed = raw ? JSON.parse(raw) : [];
          if (Array.isArray(parsed)) {
            customQuizzes = parsed;
          } else {
            customQuizzes = [];
          }
        } catch (e) {
          customQuizzes = [];
        }
      }

      function saveCustomQuizzes() {
        try {
          localStorage.setItem(CUSTOM_QUIZ_KEY, JSON.stringify(customQuizzes));
        } catch (e) {
          // ignore storage errors
        }
      }

      function getAllQuizzes() {
        return [...QUIZ_SETS, ...customQuizzes];
      }

      // -------------------
      // Populate quiz select (built-in + custom)
      // -------------------
      function populateQuizSelect() {
        quizSelect.innerHTML = '';

        const allCustom = customQuizzes;

        // Built-in group
        const builtInGroup = document.createElement('optgroup');
        builtInGroup.label = 'Built-in quizzes';

        QUIZ_SETS.forEach((q) => {
          const opt = document.createElement('option');
          opt.value = q.id;
          opt.textContent = `${q.title} (${q.category})`;
          builtInGroup.appendChild(opt);
        });

        quizSelect.appendChild(builtInGroup);

        // Custom group
        const customGroup = document.createElement('optgroup');
        customGroup.label = 'My Quizzes';

        if (allCustom.length === 0) {
          const opt = document.createElement('option');
          opt.disabled = true;
          opt.textContent = 'No custom quizzes yet';
          customGroup.appendChild(opt);
        } else {
          allCustom.forEach((q) => {
            const opt = document.createElement('option');
            opt.value = q.id;
            opt.textContent = `⭐ ${q.title}`;
            customGroup.appendChild(opt);
          });
        }

        quizSelect.appendChild(customGroup);

        // Default selection
        const allQuizzes = getAllQuizzes();
        if (allQuizzes.length) {
          currentQuiz = QUIZ_SETS[0] || allQuizzes[0];
          quizSelect.value = currentQuiz.id;
        } else {
          currentQuiz = null;
        }
      }

      quizSelect.addEventListener('change', () => {
        const id = quizSelect.value;
        const all = getAllQuizzes();
        currentQuiz = all.find((q) => q.id === id) || null;
      });

      // -------------------
      // Mode selection
      // -------------------
      function setMode(nextMode) {
        mode = nextMode;
        if (mode === 'multi') {
          playersConfig.style.display = 'block';
          modeMultiPill.classList.add('selected');
          modeSoloPill.classList.remove('selected');
        } else {
          playersConfig.style.display = 'none';
          modeSoloPill.classList.add('selected');
          modeMultiPill.classList.remove('selected');
        }
      }

      modeSoloPill.addEventListener('click', () => setMode('solo'));
      modeMultiPill.addEventListener('click', () => setMode('multi'));

      // -------------------
      // Quiz core
      // -------------------
      function startQuiz() {
        if (!currentQuiz) {
          alert('Please choose a quiz set.');
          return;
        }

        // Build players
        if (mode === 'solo') {
          players = [{ name: 'Player 1', score: 0 }];
        } else {
          const names = [
            document.getElementById('playerName1').value.trim(),
            document.getElementById('playerName2').value.trim(),
            document.getElementById('playerName3').value.trim(),
            document.getElementById('playerName4').value.trim()
          ].filter((n) => n !== '');

          if (names.length < 2) {
            alert('Please enter at least 2 player names for pass-and-play.');
            return;
          }
          players = names.map((n) => ({ name: n, score: 0 }));
        }

        currentQuestionIndex = 0;
        currentPlayerIndex = 0;
        quizRunning = true;
        resultsPanel.style.display = 'none';
        feedback.textContent = '';
        feedback.className = 'feedback-text';

        quizStatus.textContent =
          'Quiz running. Tap an answer to see if it is correct.';

        renderScoreboard();
        showQuestion();
      }

      function resetQuiz() {
        quizRunning = false;
        const all = getAllQuizzes();
        const selectedId = quizSelect.value;
        currentQuiz = all.find((q) => q.id === selectedId) || all[0] || null;

        currentQuestionIndex = 0;
        currentPlayerIndex = 0;
        players = [];
        questionHeader.style.display = 'none';
        questionText.textContent =
          'No question yet. Start a quiz to begin.';
        optionsContainer.innerHTML = '';
        feedback.textContent = '';
        feedback.className = 'feedback-text';
        scoreboard.style.display = 'none';
        scoreRows.innerHTML = '';
        resultsPanel.style.display = 'none';
        resultsList.innerHTML = '';
        quizStatus.textContent =
          'No quiz running yet. Choose a set and press “Start quiz”.';
      }

      function showQuestion() {
        if (!quizRunning || !currentQuiz) return;

        const questions = currentQuiz.questions || [];
        if (currentQuestionIndex >= questions.length) {
          endQuiz();
          return;
        }

        const q = questions[currentQuestionIndex];

        questionHeader.style.display = 'flex';
        questionProgress.textContent =
          'Question ' + (currentQuestionIndex + 1) + ' of ' + questions.length;

        if (players.length > 1) {
          currentPlayerLabel.textContent =
            'Current player: ' + players[currentPlayerIndex].name;
        } else {
          currentPlayerLabel.textContent = 'Solo mode';
        }

        questionText.textContent = q.text;
        optionsContainer.innerHTML = '';
        feedback.textContent = '';
        feedback.className = 'feedback-text';

        (q.options || []).forEach((optText, index) => {
          const btn = document.createElement('button');
          btn.className = 'option-btn';
          btn.textContent = optText;
          btn.dataset.index = index;
          btn.addEventListener('click', () => {
            handleAnswerClick(index);
          });
          optionsContainer.appendChild(btn);
        });
      }

      function handleAnswerClick(selectedIndex) {
        if (!quizRunning || !currentQuiz) return;
        const questions = currentQuiz.questions || [];
        const q = questions[currentQuestionIndex];
        const correctIndex = q.correctIndex;

        // Disable further clicks on options
        const optionButtons = optionsContainer.querySelectorAll('.option-btn');
        optionButtons.forEach((btn) => {
          btn.disabled = true;
        });

        // Highlight
        optionButtons.forEach((btn) => {
          const idx = Number(btn.dataset.index);
          if (idx === correctIndex) {
            btn.classList.add('correct');
          }
          if (idx === selectedIndex && idx !== correctIndex) {
            btn.classList.add('incorrect');
          }
        });

        // Update score
        if (selectedIndex === correctIndex && players.length > 0) {
          players[currentPlayerIndex].score += 1;
          feedback.textContent = 'Correct! Well done.';
          feedback.classList.add('correct');
        } else {
          feedback.textContent =
            'Not quite. That is okay – keep learning and try the next one.';
          feedback.classList.add('incorrect');
        }

        renderScoreboard();

        // Move to next question after short delay
        setTimeout(() => {
          currentQuestionIndex += 1;
          if (players.length > 1) {
            currentPlayerIndex =
              (currentPlayerIndex + 1) % players.length;
          }
          showQuestion();
        }, 900);
      }

      function renderScoreboard() {
        if (!players.length) {
          scoreboard.style.display = 'none';
          scoreRows.innerHTML = '';
          return;
        }
        scoreboard.style.display = 'block';
        const sorted = [...players].sort((a, b) => b.score - a.score);
        scoreRows.innerHTML = sorted
          .map((p) => {
            return `
              <div class="score-row">
                <span>${p.name}</span>
                <span>${p.score} point${p.score === 1 ? '' : 's'}</span>
              </div>
            `;
          })
          .join('');
      }

      function endQuiz() {
        quizRunning = false;

        if (!players.length) {
          resultsPanel.style.display = 'none';
          return;
        }

        // Build results
        const ranked = [...players].sort((a, b) => b.score - a.score);
        resultsList.innerHTML = ranked
          .map((p, idx) => {
            const place =
              idx === 0
                ? '1st'
                : idx === 1
                ? '2nd'
                : idx === 2
                ? '3rd'
                : (idx + 1) + 'th';
            return `
              <li>
                <strong>${place}:</strong> ${p.name} – ${p.score} point${p.score === 1 ? '' : 's'}
              </li>
            `;
          })
          .join('');
        resultsPanel.style.display = 'block';
        quizStatus.textContent =
          'Quiz finished. You can play again or choose another set.';
      }

      // -------------------
      // Custom Quiz Builder Logic
      // -------------------
      function clearCustomQuizFields() {
        customQuizTitle.value = '';

        cqQ1Text.value = '';
        cqQ1Opt1.value = '';
        cqQ1Opt2.value = '';
        cqQ1Opt3.value = '';
        cqQ1Opt4.value = '';
        cqQ1Correct.value = '';

        cqQ2Text.value = '';
        cqQ2Opt1.value = '';
        cqQ2Opt2.value = '';
        cqQ2Opt3.value = '';
        cqQ2Opt4.value = '';
        cqQ2Correct.value = '';

        cqQ3Text.value = '';
        cqQ3Opt1.value = '';
        cqQ3Opt2.value = '';
        cqQ3Opt3.value = '';
        cqQ3Opt4.value = '';
        cqQ3Correct.value = '';
      }

      function buildQuestionFromBlock(qTextEl, opt1El, opt2El, opt3El, opt4El, correctEl) {
        const text = qTextEl.value.trim();
        if (!text) {
          return null; // no question
        }

        const opts = [
          opt1El.value.trim(),
          opt2El.value.trim(),
          opt3El.value.trim(),
          opt4El.value.trim()
        ];

        // Filter out completely empty options (but keep their index mapping)
        const nonEmptyOptions = opts.map((o, idx) => ({ text: o, idx }))
          .filter((o) => o.text !== '');

        if (nonEmptyOptions.length < 2) {
          // Need at least 2 options
          return { error: 'atLeastTwoOptions' };
        }

        const correctVal = correctEl.value;
        if (correctVal === '') {
          return { error: 'noCorrectChosen' };
        }

        const correctIndex = Number(correctVal);
        if (!opts[correctIndex] || opts[correctIndex].trim() === '') {
          return { error: 'correctOptionEmpty' };
        }

        return {
          text,
          options: opts,
          correctIndex
        };
      }

      function saveCustomQuiz() {
        const title = customQuizTitle.value.trim();
        if (!title) {
          alert('Please enter a quiz title.');
          return;
        }

        const questions = [];

        // Question 1 (required if text entered)
        const q1 = buildQuestionFromBlock(
          cqQ1Text,
          cqQ1Opt1,
          cqQ1Opt2,
          cqQ1Opt3,
          cqQ1Opt4,
          cqQ1Correct
        );
        if (q1 && q1.error) {
          handleQuestionError(q1.error, 1);
          return;
        } else if (q1) {
          questions.push(q1);
        }

        // Question 2
        const q2 = buildQuestionFromBlock(
          cqQ2Text,
          cqQ2Opt1,
          cqQ2Opt2,
          cqQ2Opt3,
          cqQ2Opt4,
          cqQ2Correct
        );
        if (q2 && q2.error) {
          handleQuestionError(q2.error, 2);
          return;
        } else if (q2) {
          questions.push(q2);
        }

        // Question 3
        const q3 = buildQuestionFromBlock(
          cqQ3Text,
          cqQ3Opt1,
          cqQ3Opt2,
          cqQ3Opt3,
          cqQ3Opt4,
          cqQ3Correct
        );
        if (q3 && q3.error) {
          handleQuestionError(q3.error, 3);
          return;
        } else if (q3) {
          questions.push(q3);
        }

        if (questions.length === 0) {
          alert('Please add at least one question to your quiz.');
          return;
        }

        const newQuiz = {
          id: 'custom-' + Date.now(),
          title,
          category: 'Custom',
          difficulty: 'custom',
          questions
        };

        customQuizzes.push(newQuiz);
        saveCustomQuizzes();
        populateQuizSelect();

        customQuizStatus.textContent =
          'Quiz saved on this device. You can now find it under “My Quizzes” in the quiz list above.';
        clearCustomQuizFields();
      }

      function handleQuestionError(errorCode, questionNumber) {
        let msg = '';
        if (errorCode === 'atLeastTwoOptions') {
          msg =
            'Question ' +
            questionNumber +
            ': please provide at least two answer options.';
        } else if (errorCode === 'noCorrectChosen') {
          msg =
            'Question ' +
            questionNumber +
            ': please choose which option is correct.';
        } else if (errorCode === 'correctOptionEmpty') {
          msg =
            'Question ' +
            questionNumber +
            ': the selected correct answer is empty. Please fill it or choose another option.';
        }
        if (msg) {
          alert(msg);
        }
      }

      // -------------------
      // Event wiring
      // -------------------
      startQuizBtn.addEventListener('click', startQuiz);
      resetQuizBtn.addEventListener('click', resetQuiz);
      playAgainBtn.addEventListener('click', () => {
        if (!currentQuiz) {
          const all = getAllQuizzes();
          currentQuiz = all.find((q) => q.id === quizSelect.value) || all[0] || null;
        }
        if (!currentQuiz) {
          alert('Please choose a quiz set first.');
          return;
        }
        if (!players.length) {
          startQuiz();
          return;
        }
        players = players.map((p) => ({ name: p.name, score: 0 }));
        currentQuestionIndex = 0;
        currentPlayerIndex = 0;
        quizRunning = true;
        resultsPanel.style.display = 'none';
        feedback.textContent = '';
        feedback.className = 'feedback-text';
        quizStatus.textContent =
          'Quiz running. Tap an answer to see if it is correct.';
        renderScoreboard();
        showQuestion();
      });

      saveCustomQuizBtn.addEventListener('click', saveCustomQuiz);
      clearCustomQuizBtn.addEventListener('click', () => {
        clearCustomQuizFields();
        customQuizStatus.textContent = 'Fields cleared. No custom quiz saved yet.';
      });

      // -------------------
      // Init
      // -------------------
      loadCustomQuizzes();
      populateQuizSelect();
      resetQuiz(); // ensures clean UI on first load
    </script>
  </body>
</html>
